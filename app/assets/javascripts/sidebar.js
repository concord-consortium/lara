(function () {
  // Distance between sidebars (in pixels).
  var SIDEBAR_SPACER = 35;

  // Dynamically setup position of sidebar handles.
  function positionMultipleSidebars() {
    var sidebarTop = $('.sidebar-mod').offset().top;
    var sidebarHdrHeight = $('.sidebar-hdr').height();

    if ($('.activity-nav-mod')) {
       //Distance between floating menu and sidebar.
       sidebarTop = $('.activity-nav-mod').offset().top + $('#nav-activity-menu').height() + 50;
    }

    $('.sidebar-mod').each(function (idx) {
      $(this).css('top', sidebarTop + idx * (sidebarHdrHeight + SIDEBAR_SPACER));
    });
  }

  function setupSidebars () {
    if ($('.sidebar-mod').length > 0) {
      positionMultipleSidebars();

      $('.sidebar-hdr').add('.sidebar-bd-close').off('.sidebarToggle').on('click.sidebarToggle', function () {
        var $sidebar = $(this).closest('.sidebar-mod');
        $sidebar.toggleClass('expanded');
      });
      // It triggers CSS transition.
      $('.sidebar-mod').addClass('visible');
    }
  };

  window.Sidebar = {
    addSidebar: function (options) {
      // This code follows existing markup. We just construct it by hand.
      var $mod = $('<div class="sidebar-mod">');
      var $hdr = $('<div class="sidebar-hdr">');
      var $bd = $('<div class="sidebar-bd">');
      // Generate header.
      if (options.icon) {
        $hdr.append(options.icon);
      }
      var $title = $('<h5 class="h5">');
      $hdr.append($title);
      // Generate body.
      var $closeBtn = $('<div class="sidebar-bd-close">').text('X');
      $bd.append($closeBtn);
      var $contentContainer = $('<div class="sidebar-txt">');
      $bd.append($contentContainer);
      // Final setup.
      $mod.append($hdr);
      $mod.append($bd);
      $('#sidebars-container').append($mod);

      // Apply options.
      $title.text(options.title);
      $hdr.css('background-color', options.handleColor);
      $contentContainer.append(options.content);
      $bd.css('height', options.height);
      $mod.css('width', options.width);
      // Magic numbers - why? Too match CSS in _runtime-sidebar.scss
      $mod.css('right', options.width * -1 + 85);

      // Initialize new sidebar.
      setupSidebars();
    }
  };

  // Initialize sidebars generated by Rails template on page load.
  $(setupSidebars);
}());
